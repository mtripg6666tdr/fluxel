<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Example</title>
    <script src="./minimal-commonjs-engine.js"></script>
    <script src="./library-loader.js"></script>
    <script>
      doAfterLoad(() => {
        const createElement = require("create-element");

        const ReactiveCounter = () => (
          createElement.div([
            createElement.h1("Welcome to the example!"),
            createElement.p("This is a simple example of using the createElement function.")
          ]),
          createElement.hr(),
          createElement.div({
            style: {
              textAlign: "center",
            },
            children: [
              ...createElement.reactive({ counter: 0, opacity: 1, pref: { label: "Counter" },  }, outerState => ([
                createElement.div({
                  style: {
                    padding: "20px",
                    border: "1px solid #ccc",
                    margin: "20px 0",
                    display: "inline-block",
                    opacity: outerState.use("opacity"),
                  },
                  dataset: {
                    reactive: "true",
                    counter: outerState.use("counter"),
                  },
                  children: [
                    ...createElement.reactive({ level: 1 }, innerState => [
                      innerState.use("level", level => createElement[`h${level}`](outerState.use("counter", counter => createElement.span(`Reactive Counter: ${counter}`)))),
                      createElement.p("Click the button to increment the counter:"),
                      createElement.p(outerState.use(["counter", "pref"], ({ counter, pref }) => `Current value: ${counter} (${pref.label})`)),
                      createElement.p(outerState.use("counter").derive(counter => `The square of ${counter} is ${counter * counter}`)),
                      createElement.p("Use the buttons below to interact with the counter:"),
                      createElement.p([
                        createElement.button({
                          children: "Increment",
                          onclick: () => {
                            outerState.counter++;
                          }
                        }),
                        createElement.button({
                          children: "Reset",
                          onclick: () => {
                            outerState.counter = 0;
                          }
                        }),
                      ]),
                      createElement.p([
                        ...createElement.useUniqueString(id => [
                          createElement.label({
                            htmlFor: id,
                            children: "Label: "
                          }),
                          createElement.input({
                            type: "text",
                            placeholder: "Counter",
                            id,
                            oninput: (event) => {
                              outerState.pref.label = event.target.value || "Counter";
                              outerState.render();
                            }
                          }),
                        ]),
                      ]),
                      createElement.p([
                        ...createElement.useUniqueString(id => [
                          createElement.label({
                            htmlFor: id,
                            children: "Opacity: "
                          }),
                          createElement.input({
                            type: "range",
                            id,
                            min: 10,
                            max: 100,
                            value: outerState.use("opacity", s => s * 100).value,
                            oninput: (event) => {
                              outerState.opacity = Number(event.target.value) / 100;
                            }
                          })
                        ])
                      ]),
                      createElement.p([
                        ...createElement.useUniqueString(id => [
                          createElement.label({
                            htmlFor: id,
                            children: "Level: "
                          }),
                          createElement.select({
                            id,
                            children: [
                              createElement.option({ value: 1, children: "Level 1" }),
                              createElement.option({ value: 2, children: "Level 2" }),
                              createElement.option({ value: 3, children: "Level 3" }),
                              createElement.option({ value: 4, children: "Level 4" }),
                              createElement.option({ value: 5, children: "Level 5" }),
                              createElement.option({ value: 6, children: "Level 6" }),
                            ],
                            onchange: (event) => {
                              innerState.level = Number(event.target.value);
                            },
                          }),
                        ]),
                      ]),
                      // Conditional rendering based on the counter value
                      // Note: If you use state#use as one of items of children,
                      //       you have to manage the return type of "derive" functions to be `HTMLElement` or `string`, not `HTMLElement | string`.
                      //       Because the type of the child will be determined in the first render, and it will not change in the next renders.
                      //       If you want to eliminate this limitation, you have to wrap the whole children with state#use (outerState#use in this context).
                      outerState.use("counter", counter => counter > 0 ? createElement.hr() : createElement.span()),
                      createElement.ul(
                        outerState.use("counter", (counter, memo) => {
                          return createElement.fragment(Array.from({ length: counter }, (_, i) => i + 1).map(num =>
                            memo(() => createElement.li({
                              classList: `item-${num}`,
                              children: `Item ${num}`
                            }), num, true) // Memoize each item
                          ), {
                            classList: "item-list",
                          });
                        }),
                      ),
                    ]),
                  ],
                }),
              ])),
            ]
          })
        );

        document.body.appendChild(ReactiveCounter());

        const MyCounter = createElement.component(
          // コンポーネントのレンダラー関数: props と state を受け取ります
          (props, state) => {
            return createElement.div({
              style: {
                margin: "0 auto",
                padding: "20px",
                width: "300px",
                textAlign: "center",
              },
              children: [
                createElement.h3(props.title),
                createElement.p(state.use('count').derive(c => `現在のカウント: ${c}`)), // リアクティブなコンテンツ
                createElement.button({
                  children: "カウントを増やす",
                  onclick: () => { state.count++; }
                })
              ]
            });
          },
          // コンポーネントの初期状態 (props に基づく関数でも可)
          props => ({ count: props.initialCount || 0 })
        );

        document.body.append(
          MyCounter({ title: "最初のカウンター" }),
          MyCounter({ title: "2番目のカウンター", initialCount: 5 })
        );

        // --- TodoInput Component (スタイルを内部に定義) ---
        const TodoInput = createElement.component(
          (props, state) => {
            const handleAdd = () => {
              if (state.newTodoText.trim() !== '') {
                props.onAdd(state.newTodoText.trim());
                state.newTodoText = '';
              }
            };

            return createElement.fragment([ // fragment でラップ
              createElement.style(`
                /* Styles encapsulated within TodoInput component */
                .todo-input-section {
                  display: flex;
                  margin-bottom: 15px;
                }
                .todo-input {
                  flex-grow: 1;
                  padding: 10px;
                  border: 1px solid #ddd;
                  border-radius: 4px;
                  font-size: 1rem;
                }
                .todo-input:focus {
                  outline: none;
                  border-color: #4CAF50;
                }
                .add-button {
                  padding: 10px 15px;
                  background: #4CAF50; /* Green */
                  color: white;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 1rem;
                  margin-left: 10px;
                }
                .add-button:hover {
                  background: #45a049;
                }
              `),
              createElement.div({
                classList: 'todo-input-section',
                children: [
                  createElement.input({
                    type: 'text',
                    placeholder: 'Add a new todo',
                    value: state.use('newTodoText'),
                    oninput: (e) => {
                      state.newTodoText = e.target.value;
                    },
                    onkeydown: (e) => {
                      if (e.key === 'Enter') {
                        handleAdd();
                      }
                    },
                    classList: 'todo-input',
                  }),
                  createElement.button({
                    children: 'Add',
                    onclick: handleAdd,
                    classList: 'add-button',
                  })
                ]
              })
            ]);
          },
          { newTodoText: '' }
        );

        // --- TodoList Component ---
        const TodoList = createElement.component(
          (props) => {
            const handleDelete = (indexToDelete) => {
              props.onDelete(indexToDelete);
            };

            return createElement.fragment([
              createElement.style(`
                /* Styles encapsulated within TodoList component */
                .todo-list-container {
                  list-style: none;
                  padding: 0;
                  margin-top: 10px;
                }
                .todo-item {
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  padding: 8px 0;
                  border-bottom: 1px solid #eee;
                }
                .todo-item:last-child {
                  border-bottom: none;
                }
                .todo-text {
                  flex-grow: 1;
                }
                .delete-button {
                  margin-left: 10px;
                  background: #dc3545; /* Bootstrap's danger color */
                  color: white;
                  border: none;
                  border-radius: 4px;
                  padding: 5px 10px;
                  cursor: pointer;
                }
                .delete-button:hover {
                  opacity: 0.8;
                }
              `),
              createElement.ul({
                classList: 'todo-list-container',
                children: props.todos.derive(currentTodos => {
                  console.log("Rendering TodoList with todos:", currentTodos);
                  return currentTodos.map((todo, index) =>
                    props.memo(() => createElement.li({
                      classList: 'todo-item',
                      children: [
                        createElement.span({ classList: 'todo-text', children: todo }),
                        createElement.button({
                          children: 'X',
                          onclick: () => handleDelete(props.todos.value.indexOf(todo)),
                          classList: 'delete-button',
                        })
                      ]
                    }), todo, true)
                  )
                })
              })
            ]);
          },
          {}
        );

        // --- TodoApp Component (formerly AppState) ---
        // This component manages the overall state (todos array) and orchestrates sub-components.
        const TodoApp = createElement.component(
          (props, state) => {
            console.log("Rendering ToDoApp");

            const handleAddTodo = (newTodo) => {
              if (state.todos.includes(newTodo)) {
                // Alert if the todo already exists
                // Note: every li element for each todo items are memoized based on the todo text,
                //       so if the same todo text is added, the same li element will be appeared twice in the same list.
                //       This is a limitation of the pure-mode memoization.
                alert("This todo already exists!");
                return;
              }
              state.todos.push(newTodo);
              state.render(); // Notify state change to re-render TodoList
            };

            const handleDeleteTodo = (indexToDelete) => {
              state.todos.splice(indexToDelete, 1);
              state.render(); // Notify state change to re-render TodoList
            };

            const [todos, memo] = state.useWithMemo('todos');

            return createElement.div({
              style: { maxWidth: '400px', margin: '20px auto', border: '1px solid #ccc', padding: '20px', borderRadius: '8px', boxShadow: '0 4px 8px rgba(0,0,0,0.1)' },
              children: [
                createElement.style(`
                  /* Global/App-level styles */
                  body {
                    font-family: Arial, sans-serif;
                    line-height: 1.6;
                    background-color: #f4f4f4;
                    color: #333;
                  }
                  .app-title {
                    text-align: center;
                    color: #2c3e50;
                    margin-bottom: 20px;
                  }
                `),
                createElement.h2({ classList: 'app-title', children: 'My Todo List' }),
                ...TodoInput({ onAdd: handleAddTodo }),
                // Spread the TodoList component's return value (which is an array from fragment)
                ...TodoList({
                  todos,
                  onDelete: handleDeleteTodo,
                  memo,
                })
              ]
            });
          },
          { todos: ["Learn create-element", "Build something awesome"] } // Initial state for TodoApp
        );

        document.body.appendChild(TodoApp());
      });
    </script>
  </head>
  <body>
  </body>
</html>
